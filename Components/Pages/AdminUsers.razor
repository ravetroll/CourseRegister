@page "/Admin/Users"
@attribute [Authorize(Roles = "Admin")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using CourseRegisterApp.Data
@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using System.Linq

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Manage Users</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-4">
    <MudText Typo="Typo.h5" GutterBottom="true">User Management</MudText>
    
    <MudTable T="ApplicationUser" Items="Users" Dense="true" Hover="true" Bordered="true" Striped="true">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Existing Users</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>User</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Roles</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="User">@context.UserName</MudTd>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Roles">
               <MudChipSet T="string">
                   @if (UserRoles.TryGetValue(context.Id, out var roles))
                   {
                       @foreach (var role in roles)
                       {
                           <MudChip Text="@role" />
                       }
                   }
                </MudChipSet>
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                               Color="Color.Info" 
                               OnClick="@(() => EditUserRoles(context))" />
            </MudTd>
        </RowTemplate>
    </MudTable>

</MudContainer>

<MudDialog @bind-Visible="isDialogOpen" Style="min-width: 400px;">
    <TitleContent>
        <MudText Typo="Typo.h6">Edit Roles for @currentUser?.Email</MudText>
    </TitleContent>
    <DialogContent>
        <MudList T="IdentityRole">
            @foreach (var role in AllRoles)
            {
                <MudListItem>
                    <MudCheckBox T="bool" 
                                 Value="selectedRoles.Contains(role.Name!)"                                 
                                 ValueChanged="@((isChecked) => ToggleRole(role.Name!, isChecked))"
                                 Color="Color.Primary"
                                 Label="@role.Name" />
                </MudListItem>
            }
        </MudList>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDialog" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="SaveRolesAsync" Color="Color.Primary" Variant="Variant.Filled">Save</MudButton>
    </DialogActions>
</MudDialog>


